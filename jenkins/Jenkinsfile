pipeline {
    agent any

    // Define a global environment variable for the DB admin password and domain name.
    // This is less ideal for production (Key Vault integration is better), but works for this setup.
    environment {
        TF_VAR_admin_password = "Ap20120805877" // !! IMPORTANT: Ensure this is your actual strong password !!
        TF_VAR_domain_name    = "manikonda.ca"
    }

    stages {
        // Stage 1: Checkout Code (already handled by 'Obtained jenkins/Jenkinsfile from git...')
        // If you need to explicitly clone into a specific directory, add it here.
        // For now, assuming Jenkins handles the initial checkout.

        stage('Terraform Operations') {
            steps {
                script {
                    // Navigate to the Terraform directory within the workspace
                    // This is crucial if your Jenkinsfile is at jenkins/Jenkinsfile
                    // but your Terraform code is in the parent 'multi-region-dr' folder.
                    dir('multi-region-dr') {
                        // Use withCredentials to inject the Azure Service Principal credentials.
                        // This step automatically makes variables like AZURE_SUBSCRIPTION_ID,
                        // AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, AZURE_TENANT_ID available
                        // as environment variables within this block's scope.
                        // The 'azure-manikonda-sp-creds' is the ID you set in Jenkins Credentials.
                        withCredentials([azureServicePrincipal('azure-manikonda-sp-creds')]) {

                            // Terraform Init command:
                            // The AzureRM provider typically picks up ARM_* environment variables
                            // (e.g., ARM_CLIENT_ID, ARM_CLIENT_SECRET, ARM_SUBSCRIPTION_ID, ARM_TENANT_ID)
                            // which are automatically set by withCredentials.
                            // We explicitly pass backend config here.
                            sh """
                                terraform init \\
                                    -backend-config="resource_group_name=tfstate-manikonda-rg-unique" \\
                                    -backend-config="storage_account_name=tfstatemanikonda01" \\
                                    -backend-config="container_name=tfstate" \\
                                    -backend-config="key=multi-region-dr.tfstate"
                            """

                            // Terraform Plan command:
                            // Pass Terraform variables using the environment variables injected by withCredentials.
                            // The 'TF_VAR_' prefix is crucial for Terraform to recognize them as input variables.
                            // We use the injected AZURE_* variables directly.
                            sh """
                                terraform plan -out=tfplan \\
                                    -var "subscription_id=${AZURE_SUBSCRIPTION_ID}" \\
                                    -var "tenant_id=${AZURE_TENANT_ID}" \\
                                    -var "client_id=${AZURE_CLIENT_ID}" \\
                                    -var "client_secret=${AZURE_CLIENT_SECRET}"
                            """

                            // User input for approval before apply
                            def userInput = input(id: 'proceed', message: 'Proceed with Terraform Apply?', ok: 'Apply')
                            if (userInput == 'Apply') {
                                // Terraform Apply command:
                                // Uses the saved plan and the same injected credentials.
                                sh 'terraform apply -auto-approve tfplan'
                            } else {
                                error('Terraform apply cancelled by user.')
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            // Clean up any sensitive files or data
            script {
                dir('multi-region-dr') {
                    sh 'rm -f tfplan'
                }
            }
        }
        success {
            echo 'Terraform deployment successful!'
        }
        failure {
            echo 'Terraform deployment failed!'
        }
    }
}

